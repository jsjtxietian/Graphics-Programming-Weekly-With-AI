<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphics Programming Weekly - AI Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        .search-container { max-width: 800px; margin: 50px auto; flex: 1; }
        .result-card { 
            transition: transform 0.2s; 
            border-left: 5px solid #0d6efd;
            margin-bottom: 15px;
        }
        .result-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .hidden { display: none !important; }
        .btn-similar { font-size: 0.8rem; padding: 2px 8px; border-radius: 20px; }
        .meta-link:hover { text-decoration: underline !important; color: #0d6efd !important; }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h3 id="loading-text">Initializing...</h3>
        <p class="text-muted" id="loading-subtext">Preparing local AI model...</p>
    </div>

    <div class="container search-container">
        <div class="text-center mb-5">
            <h1 class="fw-bold display-5 mb-0">Graphics Programming Weekly</h1>
            <div class="mt-2 text-primary text-uppercase" style="font-size: 0.85rem; letter-spacing: 3px; font-weight: 600;">
                <span class="text-muted" style="font-weight: 400;">Powered by</span> AI Vector Search
            </div>
        </div>

        <div class="input-group input-group-lg mb-4 shadow-sm">
            <input type="text" id="search-input" class="form-control" placeholder="Search anything interesting (e.g., 'Volume rendering')..." disabled>
            <button class="btn btn-primary" type="button" id="search-btn">Search</button>
        </div>

        <div class="d-flex justify-content-between text-muted mb-2">
            <small>Status: <span id="status-text" class="text-success">Ready</span></small>
            <small>Index Size: <span id="db-size">0</span> items</small>
        </div>

        <div id="results-container"></div>
    </div>

    <footer class="text-center py-4 mt-5 text-muted border-top bg-white">
        <div class="container">
            <p class="mb-1">
                Data sourced from 
                <a href="https://www.jendrikillner.com/article_database/" target="_blank" class="text-decoration-none fw-bold text-dark">
                    Graphics Programming Weekly
                </a>
                by Jendrik Illner.
            </p>
            <p class="small mb-0">
                Powered by Transformers.js & all-MiniLM-L6-v2.
            </p>
        </div>
    </footer>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0';

        // === Á∫ØÊú¨Âú∞Ê®°ÂºèÈÖçÁΩÆ ===
        env.allowLocalModels = true;    
        env.allowRemoteModels = false;
        env.localModelPath = 'models/'; 

        let extractor = null;
        let database = [];
        let isReady = false;

        // [‰øÆÂ§ç] ÂÖàÂÆö‰πâÁ©∫ÂØπË±°ÔºåÈò≤Ê≠¢Á´ãÂç≥Ëé∑Âèñ DOM ÂØºËá¥ null
        const dom = {};

        async function init() {
            // [‰øÆÂ§ç] Âú®ÂáΩÊï∞ÂÜÖÈÉ®Ëé∑Âèñ DOMÔºåÁ°Æ‰øùÈ°µÈù¢Âä†ËΩΩÂÆåÊØï
            dom.loading = document.getElementById('loading');
            dom.loadingText = document.getElementById('loading-text');
            dom.loadingSubtext = document.getElementById('loading-subtext');
            dom.input = document.getElementById('search-input');
            dom.btn = document.getElementById('search-btn');
            dom.results = document.getElementById('results-container');
            dom.status = document.getElementById('status-text');
            dom.dbSize = document.getElementById('db-size');

            // [‰øÆÂ§ç] Âú®ËøôÈáåÁªëÂÆö‰∫ã‰ª∂
            if (dom.btn) {
                dom.btn.addEventListener('click', performSearch);
            }
            if (dom.input) {
                dom.input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') performSearch();
                });
            }

            try {
                dom.loadingText.innerText = "Loading Local Model...";
                dom.loadingSubtext.innerText = "Loading ONNX model from ./models/ folder...";

                const modelPromise = pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', {
                    quantized: true,
                    progress_callback: (data) => {
                        if (data.status === 'progress') {
                            dom.loadingText.innerText = `Loading: ${Math.round(data.progress)}%`;
                        }
                    }
                });

                const dataPromise = fetch('./gpw_index.json').then(res => res.json());

                const [model, data] = await Promise.all([modelPromise, dataPromise]);
                
                extractor = model;
                database = data;
                
                dom.dbSize.innerText = database.length;
                dom.loading.classList.add('hidden');
                dom.input.disabled = false;
                dom.input.focus();
                isReady = true;

                // ÊåÇËΩΩ findSimilar
                window.findSimilar = findSimilar;

            } catch (e) {
                dom.loadingText.innerText = "Error Loading Model";
                dom.loadingSubtext.innerText = "Please ensure 'models' folder exists and running locally.";
                dom.loadingSubtext.classList.add('text-danger');
                console.error(e);
            }
        }
        
        function dotProduct(a, b) {
             let sum = 0;
             for (let i = 0; i < a.length; i++) sum += a[i] * b[i];
             return sum;
        }

        async function performSearch() {
            if (!isReady) return;
            const query = dom.input.value.trim();
            if (!query) return;

            dom.status.innerText = "Thinking...";
            dom.results.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-secondary"></div></div>';

            setTimeout(async () => {
                const startTime = performance.now();
                const output = await extractor(query, { pooling: 'mean', normalize: true });
                const queryVector = output.data;
                
                runVectorSearch(queryVector, startTime);
            }, 50);
        }

        function findSimilar(docId) {
            const targetDoc = database.find(item => item.id === docId);
            if (!targetDoc) return;

            const title = targetDoc.content.split('\n')[0].replace(/.*\[(.*?)\]\((.*?)\)/, '$1');
            dom.input.value = `üîó Similar to: ${title}`;
            
            dom.status.innerText = "Finding similar items...";
            dom.results.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-secondary"></div></div>';
            
            setTimeout(() => {
                const startTime = performance.now();
                runVectorSearch(targetDoc.vector, startTime, docId);
            }, 10);
        }

        function runVectorSearch(targetVector, startTime, excludeId = null) {
            const scores = [];
            for (let i = 0; i < database.length; i++) {
                if (excludeId && database[i].id === excludeId) continue;
                const score = dotProduct(targetVector, database[i].vector);
                scores.push({ item: database[i], score: score });
            }

            scores.sort((a, b) => b.score - a.score);
            const topResults = scores.slice(0, 10);
            
            const endTime = performance.now();
            dom.status.innerText = `Found in ${(endTime - startTime).toFixed(2)}ms`;
            
            renderResults(topResults);
        }

        function renderResults(results) {
            dom.results.innerHTML = '';
            if (results.length === 0) {
                dom.results.innerHTML = '<div class="alert alert-warning">No results found.</div>';
                return;
            }
            results.forEach(res => {
                const doc = res.item;
                const scorePercent = (res.score * 100).toFixed(1);
                
                const firstLine = doc.content.split('\n')[0];
                let title = firstLine;
                let link = "#";
                let date = "Unknown";
                
                const match = firstLine.match(/^(.*?):\s*\[(.*?)\]\((.*?)\)/);
                if (match) {
                    date = match[1];
                    title = match[2];
                    link = match[3];
                }

                // ÊèêÂèñ Issue Number
                const issueMatch = doc.id.match(/Issue(\d+)_/);
                const issueNum = issueMatch ? issueMatch[1] : '??';
                const issueUrl = `https://www.jendrikillner.com/post/graphics-programming-weekly-issue-${issueNum}/`;

                const summary = doc.content.split('\n').slice(1).join('<br>').replace(/- /g, '‚Ä¢ ');

                const div = document.createElement('div');
                div.className = 'card result-card';
                div.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="card-title mb-1"><a href="${link}" target="_blank" class="text-decoration-none">${title}</a></h5>
                            <span class="badge bg-light text-dark border">${scorePercent}% Match</span>
                        </div>
                        <h6 class="card-subtitle mb-2 text-muted" style="font-size: 0.85rem;">
                            üìÖ ${date} &nbsp;|&nbsp; 
                            üîó <a href="${issueUrl}" target="_blank" class="text-decoration-none text-muted meta-link">Issue ${issueNum}</a>
                        </h6>
                        <p class="card-text text-secondary mt-2" style="font-size: 0.95rem;">${summary}</p>
                        
                        <div class="mt-3 pt-2 border-top d-flex justify-content-end">
                            <button class="btn btn-outline-primary btn-sm btn-similar" onclick="window.findSimilar('${doc.id}')">
                                ‚ú® Find Similar
                            </button>
                        </div>
                    </div>
                `;
                dom.results.appendChild(div);
            });
        }
        
        init();
    </script>
</body>
</html>