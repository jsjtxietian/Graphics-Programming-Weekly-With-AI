<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphics Programming Weekly - AI Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; color: #333; }
        .search-container { max-width: 800px; margin: 50px auto; }
        .result-card { 
            transition: transform 0.2s; 
            border-left: 5px solid #0d6efd;
            margin-bottom: 15px;
        }
        .result-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .score-badge { font-size: 0.8em; color: #6c757d; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .hidden { display: none !important; }
        .highlight { background-color: #e2f0fb; font-weight: bold; padding: 0 4px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h3 id="loading-text">Loading AI Model (25MB)...</h3>
        <p class="text-muted" id="loading-subtext">Initial download may take a few seconds.</p>
    </div>

    <div class="container search-container">
        <h1 class="text-center mb-4 fw-bold">GPW <span class="text-primary">Vector Search</span></h1>
        
        <div class="input-group input-group-lg mb-4 shadow-sm">
            <input type="text" id="search-input" class="form-control" placeholder="Search anything interesting (e.g., 'Volume rendering')..." disabled>
            <button class="btn btn-primary" type="button" id="search-btn">Search</button>
        </div>

        <div class="d-flex justify-content-between text-muted mb-2">
            <small>Status: <span id="status-text" class="text-success">Ready</span></small>
            <small>Index Size: <span id="db-size">0</span> items</small>
        </div>

        <div id="results-container"></div>
    </div>

    <script type="module">
        // 1. ÂºïÂÖ•Â∫ì
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0';

        env.allowLocalModels = true;    // ÂÖÅËÆ∏Âä†ËΩΩÊú¨Âú∞Êñá‰ª∂
        env.allowRemoteModels = false;  // Á¶ÅÊ≠¢ËÅîÁΩë‰∏ãËΩΩ (Âº∫Âà∂Áî®Êú¨Âú∞ÔºåÈò≤Ê≠¢ÂõûÈÄÄÂà∞ËøúÁ®ãÊä•Èîô)
        env.localModelPath = 'models/';
        // ==========================================

        let extractor = null;
        let database = [];
        let isReady = false;

        const dom = {
            loading: document.getElementById('loading'),
            loadingText: document.getElementById('loading-text'),
            loadingSubtext: document.getElementById('loading-subtext'), // Âä†‰∏äËøô‰∏™IDÊñπ‰æøÊèêÁ§∫
            input: document.getElementById('search-input'),
            btn: document.getElementById('search-btn'),
            results: document.getElementById('results-container'),
            status: document.getElementById('status-text'),
            dbSize: document.getElementById('db-size')
        };

        // ... ÂêéÈù¢ÁöÑ‰ª£Á†Å‰øùÊåÅ‰∏çÂèò ...
        
        // 2. ÂàùÂßãÂåñÂáΩÊï∞ÈáåÊúâ‰∏ÄÁÇπÂ∞èÂèòÂåñÔºåÂ¢ûÂä†‰∏ÄÁÇπÊèêÁ§∫‰ø°ÊÅØ
        async function init() {
            try {
                dom.loadingText.innerText = "Connecting to Mirror...";
                dom.loadingSubtext.innerText = "Downloading ONNX model (25MB) via hf-mirror.com...";

                // ËøôÈáå‰∏çÈúÄË¶ÅÊîπÔºåÂ∫ìÂÜÖÈÉ®‰ºöÁî®‰∏äÈù¢ÁöÑ remoteHost ÊãºÊé•Âú∞ÂùÄ
                // ÂÆÉ‰ºöËá™Âä®Âéª https://hf-mirror.com/Xenova/all-MiniLM-L6-v2/... ‰∏ãËΩΩ
                const modelPromise = pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', {
                    quantized: true,
                    progress_callback: (data) => {
                        if (data.status === 'progress') {
                            dom.loadingText.innerText = `Downloading Model: ${Math.round(data.progress)}%`;
                        }
                    }
                });

                const dataPromise = fetch('./gpw_index.json').then(res => res.json());

                const [model, data] = await Promise.all([modelPromise, dataPromise]);
                
                extractor = model;
                database = data;
                
                // ... ÂêéÁª≠ÈÄªËæë‰∏çÂèò ...
                dom.dbSize.innerText = database.length;
                dom.loading.classList.add('hidden');
                dom.input.disabled = false;
                dom.input.focus();
                isReady = true;

            } catch (e) {
                dom.loadingText.innerText = "Network Error";
                dom.loadingSubtext.innerText = "Failed to download model. Check console for details.";
                dom.loadingSubtext.classList.add('text-danger');
                console.error(e);
            }
        }
        
        // ... ÂÖ∂‰ªñÂáΩÊï∞ (performSearch, renderResults, bind events) ‰∏çÂèò ...
        // ... dotProduct ÂáΩÊï∞‰πü‰∏çÂèò ...
        
        // ËÆ∞ÂæóÂä†‰∏ä‰πãÂâçÁöÑ search Âíå render ÈÄªËæë
        function dotProduct(a, b) {
             let sum = 0;
             for (let i = 0; i < a.length; i++) sum += a[i] * b[i];
             return sum;
        }

        async function performSearch() {
            if (!isReady) return;
            const query = dom.input.value.trim();
            if (!query) return;

            dom.status.innerText = "Thinking...";
            dom.results.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-secondary"></div></div>';

            setTimeout(async () => {
                const startTime = performance.now();
                const output = await extractor(query, { pooling: 'mean', normalize: true });
                const queryVector = output.data;

                const scores = [];
                for (let i = 0; i < database.length; i++) {
                    const score = dotProduct(queryVector, database[i].vector);
                    scores.push({ item: database[i], score: score });
                }

                scores.sort((a, b) => b.score - a.score);
                const topResults = scores.slice(0, 10);
                const endTime = performance.now();
                
                dom.status.innerText = `Found in ${(endTime - startTime).toFixed(2)}ms`;
                renderResults(topResults);
            }, 50);
        }

        function renderResults(results) {
            dom.results.innerHTML = '';
            if (results.length === 0) {
                dom.results.innerHTML = '<div class="alert alert-warning">No results found.</div>';
                return;
            }
            results.forEach(res => {
                const doc = res.item;
                const scorePercent = (res.score * 100).toFixed(1);
                const firstLine = doc.content.split('\n')[0];
                let title = firstLine;
                let link = "#";
                let date = "Unknown";
                
                const match = firstLine.match(/^(.*?):\s*\[(.*?)\]\((.*?)\)/);
                if (match) {
                    date = match[1];
                    title = match[2];
                    link = match[3];
                }
                const summary = doc.content.split('\n').slice(1).join('<br>').replace(/- /g, '‚Ä¢ ');

                const div = document.createElement('div');
                div.className = 'card result-card';
                div.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="card-title mb-1"><a href="${link}" target="_blank" class="text-decoration-none">${title}</a></h5>
                            <span class="badge bg-light text-dark border">${scorePercent}% Match</span>
                        </div>
                        <h6 class="card-subtitle mb-2 text-muted" style="font-size: 0.85rem;">üìÖ ${date} | üìÑ ${doc.id.replace('.md', '')}</h6>
                        <p class="card-text text-secondary mt-2" style="font-size: 0.95rem;">${summary}</p>
                    </div>
                `;
                dom.results.appendChild(div);
            });
        }
        
        // ÁªëÂÆö‰∫ã‰ª∂
        dom.btn.addEventListener('click', performSearch);
        dom.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        init();
    </script>
</body>
</html>